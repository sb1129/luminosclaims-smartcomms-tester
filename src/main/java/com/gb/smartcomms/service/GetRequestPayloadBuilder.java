package com.gb.smartcomms.service;

import com.gb.smartcomms.domain.ComplexGetRequest;
import com.gb.smartcomms.domain.ComplexGetRequest.Address;
import com.gb.smartcomms.domain.ComplexGetRequest.OrganisationRecipient;
import com.gb.smartcomms.domain.ComplexGetRequest.PersonRecipient;
import com.gb.smartcomms.domain.GetRequest;
import com.gb.smartcomms.domain.SimpleGetRequest;

import java.text.MessageFormat;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public final class GetRequestPayloadBuilder {
    private static final String COMPLEX_TEMPLATE = "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?><ns3:Correspondence xmlns:ns2=\"http://www.gallagherbasset.com.au/smartcommsappliance\" xmlns:ns3=\"http://www.gallagherbasset.com.au/smartcommsintegrations\"><RequestDetails><RequestGenerationTime>2020-01-01T12:00:00.000+10:00</RequestGenerationTime><Region>au</Region><Client>gi</Client><Channel>Web</Channel><TemplateId>{0}</TemplateId><Recipients>{1}</Recipients><EmailRecipients>{2}</EmailRecipients><SenderAddress>{3}</SenderAddress><Subject>{4}</Subject><ResponseBody></ResponseBody><MainRecipientParticipant/><AttachmentSource>{5}</AttachmentSource><SignatureTemplateId>{6}</SignatureTemplateId></RequestDetails>{7}{8}</ns3:Correspondence>";
    private static final String PERSON_RECIPIENT_TEMPLATE = "<Recipient><CustomerNumber>{0}</CustomerNumber><PartyName>{1} {2} {3}</PartyName><Person><Title>{1}</Title><FirstName>{2}</FirstName><LastName>{3}</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person>{7}{4}{5}<Email>{6}</Email></Recipient>";
    private static final String ORGANISATION_RECIPIENT_TEMPLATE = "<Recipient><CustomerNumber>{0}</CustomerNumber><PartyName>{2}</PartyName><Organisation><ShortName>{1}</ShortName><Name>{2}</Name><ABN>{3}</ABN><BankAccount>{4}</BankAccount></Organisation>{8}{5}{6}<Email>{7}</Email></Recipient>";
    private static final String ADDRESS_TEMPLATE = "<Address><StreetAddress>{0}</StreetAddress><Suburb>{1}</Suburb>{3}<PostCode>{4}</PostCode><Country>{5}</Country><AsString>{0}, {1}, {2}, {4}, {5}</AsString></Address>";
    private static final String DEFAULT_NOTIFICATION_TEMPLATE = "<Notification><CaseNumber>{0}</CaseNumber><SummaryIncidentDescription>fsfdsfsd</SummaryIncidentDescription><DateCreated>2020-02-03T08:12:57.850+10:00</DateCreated><ReportedToNotifierDate>2020-01-09T14:00:00.000Z</ReportedToNotifierDate><ReportedToGBDate>2020-02-02T22:13:31.000+10:00</ReportedToGBDate><Participant><Role>Insured</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Notifier</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Insurer</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>252</CustomerNumber><PartyName>Apollo Property Developers</PartyName><Organisation><ShortName>APOLLO</ShortName><Name>Apollo Property Developers</Name><ABN>APOLLO9786</ABN><BankAccount>NWBK15655648</BankAccount></Organisation><Address><StreetAddress>1807 Azalea Place Road, , South Hall</StreetAddress><Suburb>London</Suburb><PostCode>UB1 1DQ</PostCode><Country>United Kingdom</Country><AsString>1807 Azalea Place Road, , South Hall, London, United Kingdom, UB1 1DQ</AsString></Address><PhoneNumber>207337700</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>websiteenquiries@sompocanopius.com</Email></Party></Participant></Notification>";
    private static final String DEFAULT_CASE_TEMPLATE = "<Case><CaseNumber>{0}</CaseNumber><CaseType>Property Claim</CaseType><Description></Description><DateCreated>2020-02-03T08:15:58.397+10:00</DateCreated><IncidentDate>2020-01-01T14:00:00.000Z</IncidentDate><CurrentUser><Name>Generic Claims Consultant</Name><ContactNumber>01155555555</ContactNumber><ContactEmail>gencm@gbtpa.com.au</ContactEmail><Role>Claims Consultant</Role><DefaultDepartment>State Department</DefaultDepartment><Department>Generic Product</Department></CurrentUser><ClaimHandler><Name>Generic Claims Consultant</Name><ContactNumber>01155555555</ContactNumber><ContactEmail>gencm@gbtpa.com.au</ContactEmail><Role>Claims Consultant</Role><DefaultDepartment>State Department</DefaultDepartment><Department>Generic Product</Department></ClaimHandler><Participant><Role>Insured</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Claim Contact</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Insurer</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>252</CustomerNumber><PartyName>Apollo Property Developers</PartyName><Organisation><ShortName>APOLLO</ShortName><Name>Apollo Property Developers</Name><ABN>APOLLO9786</ABN><BankAccount>NWBK15655648</BankAccount></Organisation><Address><StreetAddress>1807 Azalea Place Road, , South Hall</StreetAddress><Suburb>London</Suburb><PostCode>UB1 1DQ</PostCode><Country>United Kingdom</Country><AsString>1807 Azalea Place Road, , South Hall, London, United Kingdom, UB1 1DQ</AsString></Address><PhoneNumber>207337700</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>websiteenquiries@sompocanopius.com</Email></Party></Participant><Participant><Role>Notifier</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Claimant</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Policy><PolicyNumber>1234</PolicyNumber><PolicyReference>{1}</PolicyReference><Status>Open</Status><PolicyStartDate>2016-01-26T01:00:00.000+10:00</PolicyStartDate><PolicyEndDate>2022-12-31T10:00:00.000+10:00</PolicyEndDate><Product>Property</Product><SumInsuredAmount>0.00</SumInsuredAmount><InsuredExcessAmount>0.00</InsuredExcessAmount><ExcessMethod>Deduction</ExcessMethod><InsuredPolicyStartDate>2020-01-01T00:00:00.000+10:00</InsuredPolicyStartDate><InsuredPolicyEndDate>2020-12-31T00:00:00.000+10:00</InsuredPolicyEndDate><InsuredPolicyTimezone>GMT+00:00  United Kingdom  Greenwich Mean Time  GMT</InsuredPolicyTimezone><InsuredPolicyTimezoneEnum>512128006</InsuredPolicyTimezoneEnum><ClassOfBusiness>Professional Indemnity</ClassOfBusiness><ManagedBy>Adjusting Associates</ManagedBy></Policy><Benefit><BenefitCaseNumber>UK000171-01-01</BenefitCaseNumber><Status>Open</Status><BenefitCaseType>Property Benefit</BenefitCaseType><ProductType></ProductType><Description></Description><DateCreated>2020-02-03T08:18:02.873+10:00</DateCreated><FinancialDetails><Payments><Payment><Payee>Mr Srikanth Behra</Payee><PayeeReference>test</PayeeReference><PaymentMethod>EFT</PaymentMethod><PaymentApprovedDate>2020-02-03T11:59:31.983+10:00</PaymentApprovedDate><PaymentCreatedDate>2020-02-03T00:00:00.000+10:00</PaymentCreatedDate><isPaymentApproved>Yes</isPaymentApproved><PaymentDescriptor>Expenses - Cash Amount</PaymentDescriptor><PaymentDescriptorEnumId>71070002</PaymentDescriptorEnumId><PaymentTypeEnumId>71008001</PaymentTypeEnumId><PaymentType>Adhoc</PaymentType><PaymentStatus>Active</PaymentStatus><PaymentStatusEnumId>64256005</PaymentStatusEnumId><PEStatus>PendingActive</PEStatus><isStatisticalPayment>No</isStatisticalPayment><Amount>2000.00</Amount><AdjustedAmount>2000.00</AdjustedAmount><GSTRate>20</GSTRate><PayeesITCPercent>30.00</PayeesITCPercent><PaymentAddress>Royal &amp; AncientForgan House, The LinksST. ANDREWSFIFEKY16 9JB</PaymentAddress><EFTPaymentDetails><InstitutionName>NATIONAL WESTMINSTER BANK PLC</InstitutionName><BankBranchName>CARDIFF, QUEEN STREET (A)</BankBranchName><BankCode>NWBK</BankCode><AccountName>Mr Srikanth Behra</AccountName><BankAccount>23989613</BankAccount><BankSortCode>01-01-55</BankSortCode><AccountType>Domestic Account</AccountType></EFTPaymentDetails></Payment><Payment><Payee>Mr Srikanth Behra</Payee><PayeeReference>test2</PayeeReference><PaymentMethod>EFT</PaymentMethod><PaymentApprovedDate>2020-02-02T23:05:17.367+10:00</PaymentApprovedDate><PaymentCreatedDate>2020-02-03T00:00:00.000+10:00</PaymentCreatedDate><isPaymentApproved>Yes</isPaymentApproved><PaymentDescriptor>Expenses - Cash Amount</PaymentDescriptor><PaymentDescriptorEnumId>71070002</PaymentDescriptorEnumId><PaymentTypeEnumId>71008001</PaymentTypeEnumId><PaymentType>Adhoc</PaymentType><PaymentStatus>Active</PaymentStatus><PaymentStatusEnumId>64256005</PaymentStatusEnumId><PEStatus>PendingActive</PEStatus><isStatisticalPayment>No</isStatisticalPayment><Amount>3000.00</Amount><AdjustedAmount>3000.00</AdjustedAmount><GSTRate>20</GSTRate><PayeesITCPercent>30.00</PayeesITCPercent><PaymentAddress>Royal &amp; AncientForgan House, The LinksST. ANDREWSFIFEKY16 9JB</PaymentAddress><EFTPaymentDetails><InstitutionName>NATIONAL WESTMINSTER BANK PLC</InstitutionName><BankBranchName>CARDIFF, QUEEN STREET (A)</BankBranchName><BankCode>NWBK</BankCode><AccountName>Mr Srikanth Behra</AccountName><BankAccount>23989613</BankAccount><BankSortCode>01-01-55</BankSortCode><AccountType>Domestic Account</AccountType></EFTPaymentDetails></Payment><Payment><Payee>Mr Srikanth Behra</Payee><PayeeReference>test3</PayeeReference><PaymentMethod>EFT</PaymentMethod><PaymentApprovedDate>2020-02-02T23:08:16.737+10:00</PaymentApprovedDate><PaymentCreatedDate>2020-02-03T00:00:00.000+10:00</PaymentCreatedDate><isPaymentApproved>Yes</isPaymentApproved><PaymentDescriptor>Expenses - Cash Amount</PaymentDescriptor><PaymentDescriptorEnumId>71070002</PaymentDescriptorEnumId><PaymentTypeEnumId>71008001</PaymentTypeEnumId><PaymentType>Adhoc</PaymentType><PaymentStatus>Active</PaymentStatus><PaymentStatusEnumId>64256005</PaymentStatusEnumId><PEStatus>PendingActive</PEStatus><isStatisticalPayment>No</isStatisticalPayment><Amount>4000.00</Amount><AdjustedAmount>4000.00</AdjustedAmount><GSTRate>20</GSTRate><PayeesITCPercent>30.00</PayeesITCPercent><PaymentAddress>Royal &amp; AncientForgan House, The LinksST. ANDREWSFIFEKY16 9JB</PaymentAddress><EFTPaymentDetails><InstitutionName>NATIONAL WESTMINSTER BANK PLC</InstitutionName><BankBranchName>CARDIFF, QUEEN STREET (A)</BankBranchName><BankCode>NWBK</BankCode><AccountName>Mr Srikanth Behra</AccountName><BankAccount>23989613</BankAccount><BankSortCode>01-01-55</BankSortCode><AccountType>Domestic Account</AccountType></EFTPaymentDetails></Payment></Payments><Reserves><Reserve><ReserveTypeName>Legal Costs Coverage</ReserveTypeName><ReserveTypeEnumId>72608140</ReserveTypeEnumId><Reserve>1000.00</Reserve><PaidToDate>0.00</PaidToDate><BalanceOutstanding>1000.00</BalanceOutstanding></Reserve><Reserve><ReserveTypeName>Legal Costs Defence</ReserveTypeName><ReserveTypeEnumId>72608145</ReserveTypeEnumId><Reserve>9000.00</Reserve><PaidToDate>9000.00</PaidToDate><BalanceOutstanding>0.00</BalanceOutstanding></Reserve></Reserves><ReserveTotals><RecoveredToDate>0.000000</RecoveredToDate><Reserve>10000.000000</Reserve><PaidToDate>9000.000000</PaidToDate><NetReserve>1000.000000</NetReserve><ApprovedToDate>0.000000</ApprovedToDate><BalanceOutstanding>1000.000000</BalanceOutstanding><ReserveCategory><ReserveCategoryName>Property Expenses</ReserveCategoryName><ReserveCategoryNameEnumId>72702005</ReserveCategoryNameEnumId><TotalAmount>10000.00</TotalAmount><ApprovedToDate>10000.00</ApprovedToDate><PaidToDate>9000.00</PaidToDate><BalanceOutstanding>1000.00</BalanceOutstanding></ReserveCategory><ReserveCategory><ReserveCategoryName>Property Settlement</ReserveCategoryName><ReserveCategoryNameEnumId>72702006</ReserveCategoryNameEnumId><TotalAmount>0</TotalAmount><ApprovedToDate>0</ApprovedToDate><PaidToDate>0</PaidToDate><BalanceOutstanding>0</BalanceOutstanding></ReserveCategory></ReserveTotals></FinancialDetails><Participant><Role>Insured</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant><Participant><Role>Insurer</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>252</CustomerNumber><PartyName>Apollo Property Developers</PartyName><Organisation><ShortName>APOLLO</ShortName><Name>Apollo Property Developers</Name><ABN>APOLLO9786</ABN><BankAccount>NWBK15655648</BankAccount></Organisation><Address><StreetAddress>1807 Azalea Place Road, , South Hall</StreetAddress><Suburb>London</Suburb><PostCode>UB1 1DQ</PostCode><Country>United Kingdom</Country><AsString>1807 Azalea Place Road, , South Hall, London, United Kingdom, UB1 1DQ</AsString></Address><PhoneNumber>207337700</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>websiteenquiries@sompocanopius.com</Email></Party></Participant><Participant><Role>Payee</Role><DateStarted>2020-02-03T00:00:00.000+10:00</DateStarted><Party><CustomerNumber>3</CustomerNumber><PartyName>Mr Srikanth Behra</PartyName><Person><Title>Mr</Title><FirstName>Srikanth</FirstName><LastName>Behra</LastName><DateOfBirth>2020-01-01+10:00</DateOfBirth></Person><Address><StreetAddress>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS</StreetAddress><Suburb>FIFE</Suburb><PostCode>KY16 9JB</PostCode><Country>United Kingdom</Country><AsString>Royal &amp; Ancient, Forgan House, The Links, ST. ANDREWS, FIFE, United Kingdom, KY16 9JB</AsString></Address><PhoneNumber>04645645676</PhoneNumber><PhoneNumberCountryCode>44</PhoneNumberCountryCode><Email>srikanth_behra@gbtpa.com.au</Email></Party></Participant></Benefit><ClosureDate>2020-02-13T11:46:24.930+10:00</ClosureDate><ReopeningDate>2020-02-13T11:46:24.931+10:00</ReopeningDate><ReopeningReason></ReopeningReason><IncidentLocation><StreetAddress>10 Downing Street, South Normanton, ALFRETON</StreetAddress><Suburb>DERBYSHIRE</Suburb><PostCode>DE55 2HE</PostCode><Country>United Kingdom</Country><AsString>10 Downing Street, South Normanton, ALFRETON, DERBYSHIRE, United Kingdom, DE55 2HE</AsString></IncidentLocation><JurisdictionLocation>Unknown</JurisdictionLocation></Case>";

    private GetRequestPayloadBuilder() {
        // Do nothing
    }

    public static String getPayload(final GetRequest request) {
        if (request instanceof SimpleGetRequest) {
            return ((SimpleGetRequest) request).getPayload();
        } else if (request instanceof ComplexGetRequest) {
            return getPayload((ComplexGetRequest) request);
        } else {
            throw new UnsupportedOperationException("Unsupported GetRequest type supplied");
        }
    }

    private static String getPayload(final ComplexGetRequest request) {
        final String notificationFragment = MessageFormat.format(Optional.ofNullable(request.getNotificationTemplate()).orElse(DEFAULT_NOTIFICATION_TEMPLATE), request.getNotificationNumber());
        final String caseFragment = MessageFormat.format(Optional.ofNullable(request.getCaseTemplate()).orElse(DEFAULT_CASE_TEMPLATE), request.getCaseNumber(), request.getPolicyRef());

        final String recipientEmailsFragment = Stream.concat(request.getPersonRecipients().stream().map(PersonRecipient::getEmail), request.getOrganisationRecipients().stream().map(OrganisationRecipient::getEmail)).collect(Collectors.joining("; "));
        final String recipientsFragment = getRecipientsFragment(request);

        return MessageFormat.format(COMPLEX_TEMPLATE, request.getSmartCommsTemplateId(), recipientEmailsFragment, recipientsFragment, request.getSenderEmail(), request.getSubject(), request.getAttachmentSource(), request.getSignatureTemplateId(), notificationFragment, caseFragment);
    }

    private static String getRecipientsFragment(final ComplexGetRequest request) {
        return Stream.concat(
                request.getPersonRecipients().stream().map(GetRequestPayloadBuilder::getPersonRecipientFragment),
                request.getOrganisationRecipients().stream().map(GetRequestPayloadBuilder::getOrganisationRecipientFragment)
        ).collect(Collectors.joining());
    }

    private static String getPersonRecipientFragment(PersonRecipient recipient) {
        final String phoneNumberFragment = Optional.ofNullable(recipient.getPhoneNumber()).map(pn -> "<PhoneNumber>" + pn + "</PhoneNumber><PhoneNumberCountryCode>61</PhoneNumberCountryCode>").orElse("");
        final String mobileNumberFragment = Optional.ofNullable(recipient.getMobileNumber()).map(pn -> "<MobileNumber>" + pn + "</MobileNumber><MobileNumberCountryCode>61</MobileNumberCountryCode>").orElse("");

        return MessageFormat.format(PERSON_RECIPIENT_TEMPLATE, recipient.getCustomerNumber(), recipient.getTitle(), recipient.getFirstName(), recipient.getLastName(), phoneNumberFragment, mobileNumberFragment, recipient.getEmail(), getAddressFragment(recipient.getAddress()));
    }

    private static String getOrganisationRecipientFragment(OrganisationRecipient recipient) {
        final String phoneNumberFragment = Optional.ofNullable(recipient.getPhoneNumber()).map(pn -> "<PhoneNumber>" + pn + "</PhoneNumber><PhoneNumberCountryCode>61</PhoneNumberCountryCode>").orElse("");
        final String mobileNumberFragment = Optional.ofNullable(recipient.getMobileNumber()).map(pn -> "<MobileNumber>" + pn + "</MobileNumber><MobileNumberCountryCode>61</MobileNumberCountryCode>").orElse("");

        return MessageFormat.format(ORGANISATION_RECIPIENT_TEMPLATE, recipient.getCustomerNumber(), recipient.getShortName(), recipient.getName(), recipient.getAbn(), recipient.getBankAccount(), phoneNumberFragment, mobileNumberFragment, recipient.getEmail(), getAddressFragment(recipient.getAddress()));
    }

    private static String getAddressFragment(final Address address) {
        final String stateFragment1 = Optional.ofNullable(address.getState()).map(s -> s + ",").orElse("");
        final String stateFragment2 = Optional.ofNullable(address.getState()).map(s -> "<State>" + s + "</State>").orElse("");
        return MessageFormat.format(ADDRESS_TEMPLATE, address.getStreetAddress(), address.getSuburb(), stateFragment1, stateFragment2, address.getPostCode(), address.getCountry());
    }
}
